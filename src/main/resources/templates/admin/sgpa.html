<!DOCTYPE html>
<html
        lang="en"
        xmlns:th="http://www.thymeleaf.org"
        th:replace="admin/base::layout(~{::section},~{::title},~{::script},~{::style})"
>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add SGPA</title>
  <style>
    .file-size-error {
      display: none;
      color: red;
      margin-top: 5px;
    }

    .file-input {
      display: none;
      margin-top: 10px;
    }

    label{
      color: black;
    }

    /* Custom styles for better responsiveness */
    @media (max-width: 576px) {
      .form-group label {
        font-size: 14px;
      }
      .form-control {
        font-size: 14px;
      }
    }

    @media (max-width: 768px) {
      .container {
        width: 100%;
        padding: 0 10px;
      }
      .col-md-6 {
        flex: 0 0 100%;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
<section>
  <div
          id="alert"
          th:if="${session.message}"
          th:classappend="${session.message.type}"
          class="alert my-2 mx-4"
          style="height: 60px"
          role="alert"
  >
    <p class="text-center" th:text="${session.message.content}"></p>
    <th:block th:text="${@sessionHelper.removeMessage()}"></th:block>
  </div>
  <div class="container flex-fill mt-2">
    <div class="card mx-3 mt-3">
      <div class="card-header text-white text-center" style="background-color: darkcyan">
        <h4 class="mb-0">Add SGPA</h4>
      </div>
      <div class="card-body" style=" background-color: #e2e2e2">
        <form method="post" th:action="@{/admin/process-add-sgpa}" enctype="multipart/form-data" id="uploadForm">
          <h2>Add SGPA for Semesters</h2>

          <div class="row mb-3">
            <div class="col-12 col-md-6">
              <div class="form-group">
                <label for="rollNo">Enter Student ID:</label>
                <input type="text" class="form-control" id="rollNo" name="rollNo" required />
              </div>
            </div>
          </div>

          <div id="semesterContainer">
            <!-- First semester selection -->
            <div class="semester-sgpa" id="semester-1">
              <label for="semester-select-1">Select Semester:</label>
              <select id="semester-select-1" name="semester" class="semester-select" onchange="handleSemesterChange(1)">
                <option value="">Select Semester</option>
                <option value="1">Semester 1</option>
                <option value="2">Semester 2</option>
                <option value="3">Semester 3</option>
                <option value="4">Semester 4</option>
                <option value="5">Semester 5</option>
                <option value="6">Semester 6</option>
                <option value="7">Semester 7</option>
                <option value="8">Semester 8</option>
              </select>
              <input type="file" name="sgpa1" id="file-1" required class="file-input"/>
            </div>
          </div>

          <button type="button" style="background-color: darkslategray;margin: 10px; color: white;border-radius: 5px" class="add-semester-btn" onclick="addSemester()">Add Another Semester</button>

          <div class="text-center mt-5">
            <button type="submit" class="btn btn-lg" style="background-color: darkcyan;color: white">Submit</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<script>
  const maxFileSize = 2 * 1024 * 1024;
  function validateFileSize(inputElement, errorElement) {
    const file = inputElement.files[0];
    if (file && file.size > maxFileSize) {
      errorElement.style.display = 'block';
      return false;
    } else {
      errorElement.style.display = 'none';
      return true;
    }
  }


  let semesterCount = 1;

  // Function to toggle file input based on semester selection and ensure no repeated selections
  function handleSemesterChange(semesterId) {
    const semesterSelect = document.getElementById('semester-select-' + semesterId);
    const fileInput = document.getElementById('file-' + semesterId);

    if (semesterSelect.value !== '') {
      fileInput.style.display = 'inline';
      fileInput.setAttribute('name', 'sgpa' + semesterSelect.value);  // Set the name attribute dynamically
    } else {
      fileInput.style.display = 'none';
      fileInput.removeAttribute('name');  // Remove the name attribute if no semester is selected
    }

    updateOptions();
  }

  // Function to update options in all select elements to prevent repeated selections
  function updateOptions() {
    // Get all selected semester values
    const selectedValues = Array.from(document.querySelectorAll('.semester-select'))
            .map(select => select.value)
            .filter(value => value !== "");  // Filter out the empty selections

    // Disable selected values in all other select elements
    document.querySelectorAll('.semester-select').forEach(select => {
      const currentSelectValue = select.value;
      Array.from(select.options).forEach(option => {
        if (selectedValues.includes(option.value) && option.value !== currentSelectValue) {
          option.disabled = true;  // Disable the option if already selected elsewhere
        } else {
          option.disabled = false;  // Re-enable it if not selected elsewhere
        }
      });
    });
  }

  // Function to add another semester selection
  function addSemester(event) {

    if (semesterCount >= 8) {
      alert("You can only add SGPA for up to 8 semesters.");
      return;
    }

    semesterCount++;

    const semesterContainer = document.getElementById('semesterContainer');
    const newSemesterDiv = document.createElement('div');
    newSemesterDiv.classList.add('semester-sgpa');
    newSemesterDiv.setAttribute('id', 'semester-' + semesterCount);

    newSemesterDiv.innerHTML = `
                <label for="semester-select-${semesterCount}">Select Semester:</label>
                <select id="semester-select-${semesterCount}" name="semester" class="semester-select" onchange="handleSemesterChange(${semesterCount})">
                    <option value="">Select Semester</option>
                    <option value="1">Semester 1</option>
                    <option value="2">Semester 2</option>
                    <option value="3">Semester 3</option>
                    <option value="4">Semester 4</option>
                    <option value="5">Semester 5</option>
                    <option value="6">Semester 6</option>
                    <option value="7">Semester 7</option>
                    <option value="8">Semester 8</option>
                </select>
                <input type="file" id="file-${semesterCount}" name="sgpa${semesterCount}" required class="file-input"/>
            `;

    semesterContainer.appendChild(newSemesterDiv);
    updateOptions();  // Update options in all selects to prevent duplicate selections
  }

  window.onload = function () {
    const alertBox = document.getElementById('alert');
    if (alertBox) {
      setTimeout(function () {
        alertBox.style.display = 'none';
      }, 3000);
    }
  };
</script>
</body>
</html>
